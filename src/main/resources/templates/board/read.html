<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic}" lang="ko">
<meta charset="UTF-8">

<div layout:fragment="content">
    <div class="container mt-5">
        <input type="hidden" id="boardId" th:value="${dto.boardId}">
        <input type="hidden" id="userId" th:value="${loggedInUser != null ? loggedInUser.userId : 0}">
        <!-- 삭제 및 수정 버튼 그룹 (오른쪽에 한 줄로 정렬) -->
        <div class="btn-group float-end" role="group" th:if="${loggedInUser != null and loggedInUser.userId == dto.userId}">
            <button type="button" class="btn btn-danger" th:onclick="|deletePost(${dto.boardId})|">삭제</button>
            <button type="button" class="btn btn-info" th:onclick="|modifyPost(${dto.boardId})|">수정</button>
        </div>
        <h2 th:text="${dto.title}">Board Title</h2>

        <div class="form-group mt-3">
            <div th:if="${dto.fileNames != null && !dto.fileNames.isEmpty()}">
                <div th:each="file : ${dto.fileNames}" class="mt-2">
                    <th:block th:if="${file.toLowerCase().endsWith('.png') || file.toLowerCase().endsWith('.jpg') || file.toLowerCase().endsWith('.jpeg') || file.toLowerCase().endsWith('.gif')}">
                        <img th:src="@{/upload/{file}(file=${file})}" class="img-thumbnail" style="max-width: 100%; height: auto; margin: 5px;" alt="Image preview">
                    </th:block>
                    <th:block th:if="${!(file.toLowerCase().endsWith('.png') || file.toLowerCase().endsWith('.jpg') || file.toLowerCase().endsWith('.jpeg') || file.toLowerCase().endsWith('.gif'))}">
                        <p><a th:href="@{/upload/{file}(file=${file})}" th:text="${file}" target="_blank">File Download</a></p>
                    </th:block>
                </div>
            </div>
            <div th:if="${dto.fileNames == null || dto.fileNames.isEmpty()}">
                <p>No files uploaded.</p>
            </div>
        </div>

        <!-- 게시글 내용 표시 -->
        <div class="form-group mt-3">
            <p th:text="${dto.content}">게시글 내용이 여기에 표시됩니다.</p>
        </div>

        <!-- 현재 페이지 링크 공유버튼 -->
        <div class="form-group mt-3" th:if="${dto.purchaseLink != null}">
            <div class="input-group">
                <!-- 왼쪽에 "구매 링크" 레이블 -->
                <div class="input-group-prepend">
                    <span class="input-group-text">구매 링크</span>
                </div>

                <!-- URL 주소 입력 필드 (읽기 전용) -->
                <input type="text" class="form-control" id="purchaseLink" th:value="${dto.purchaseLink != null ? dto.purchaseLink : ''}" readonly>

                <!-- 오른쪽에 복사 버튼 -->
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="copyLink()">
                        <img th:src="@{/images/copyLink.png}" alt="링크 복사" style="width: 24px; height: 24px;">
                    </button>
                </div>
            </div>
            <small id="copyAlert" class="form-text text-muted" style="display: none;">URL copied to clipboard!</small>
        </div>

        <a href="/list" class="btn btn-secondary float-end mt-4">돌아가기</a>

    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="my-4 ">
                <button class="btn btn-info addReplyBtn">댓글 쓰기</button>
            </div>
            <ul id="replyList" class="list-group replyList">
                <li th:each="reply : ${replies}" class="list-group-item">
                    <strong th:text="${reply.replyer}">작성자</strong>:
                    <span th:text="${reply.content}">댓글 내용</span>
                    <p th:text="${#temporals.format(reply.createdDate, 'yyyy-MM-dd HH:mm')}"></p>
                </li>
            </ul>

        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <ul class="pagination replyPaging">
            </ul>
        </div>
    </div>

    <div class="modal registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register Reply</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Reply Text</span>
                        <input type="text" class="form-control replyText" name="content" placeholder="댓글을 입력하세요" required>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Replyer</span>
                        <input type="text" class="form-control replyer" name="replyer" placeholder="작성자 이름" th:value="${loggedInUser.nickname}" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary registerBtn">Register</button>
                    <button type="button" class="btn btn-outline-dark closeRegisterBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- end regist modal -->

    <div class="modal modifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title replyHeader"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Reply Text</span>
                        <input type="text" class="form-control modifyText" >
                    </div>
                </div>


                <div class="modal-footer">
                    <button type="button" class="btn btn-info modifyBtn">Modify</button>
                    <button type="button" class="btn btn-danger removeBtn">Remove</button>
                    <button type="button" class="btn btn-outline-dark closeModifyBtn">Close</button>
                </div>
            </div>
        </div>
    </div> <!--modifyModal -->

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script th:inline="javascript">
        /* 현재 로그인한 사용자의 정보를 window.loggedInUser 변수에 담기 */
        window.loggedInUser = /*[[${loggedInUser}]]*/ null;
    </script>

    <script>
        // 지정된 URL을 복사하는 함수
        function copyLink() {
            const url = document.getElementById("purchaseLink").value; // 특정 URL을 가져옴
            navigator.clipboard.writeText(url)
                .then(() => {
                    alert('URL이 복사되었습니다!');
                })
                .catch(err => {
                    console.error('복사에 실패했습니다', err);
                });
        }

        // 게시글 삭제 기능
        function deletePost(boardId) {
            if (confirm("정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
                fetch(`/delete/${boardId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        alert("게시글이 성공적으로 삭제되었습니다.");
                        window.location.href = "/list";  // 삭제 후 리스트 페이지로 이동
                    } else {
                        alert("게시글 삭제에 실패했습니다. 다시 시도해주세요.");
                    }
                }).catch(error => {
                    console.error("Error:", error);
                    alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
                });
            }
        }

        // 게시글 수정 기능
        function modifyPost(boardId) {
            if (confirm("게시글을 수정하시겠습니까?")) {
                window.location.href = `/modify/${boardId}`;
            }
        }

        // 페이지 로드 시 댓글 목록을 자동으로 불러오기
        document.addEventListener("DOMContentLoaded", function() {
            printReplies(1, 10, true); // 초기 페이지 번호와 사이즈를 설정하여 호출
        });


        // 댓글 등록 모달 관련
        const registerModal = new bootstrap.Modal(document.querySelector(".registerModal"));
        const registerBtn = document.querySelector(".registerBtn");
        const closeRegisterBtn = document.querySelector(".closeRegisterBtn");

        document.querySelector(".addReplyBtn").addEventListener("click", function () {
            registerModal.show();
        });

        closeRegisterBtn.addEventListener("click", function () {
            registerModal.hide();
        });

        // 댓글 등록 버튼 클릭 시
        registerBtn.addEventListener("click", function(e) {
            const replyObj = {
                boardId: document.getElementById('boardId').value,
                userId: document.getElementById('userId').value,
                content: document.querySelector(".replyText").value.trim(), // 댓글 내용
                replyer: document.querySelector(".replyer").value.trim()    // 작성자
            };

            if (replyObj.content) {  // content 값이 존재하는지 확인
                addReply(replyObj);
            } else {
                alert("댓글 내용을 입력해 주세요!");
            }
        });

        // 댓글 등록 기능
        function addReply(replyObj) {
            fetch("/replies", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(replyObj)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Failed to add reply");
                    }
                })
                .then(data => {
                    console.log("Reply added:", data);
                    alert("댓글이 성공적으로 등록되었습니다.");
                    registerModal.hide();  // 댓글 등록 후 모달 닫기
                    window.location.reload(); // 페이지 새로고침
                })
                .catch(error => {
                    console.error("Error adding reply:", error);
                    alert("댓글 등록에 실패했습니다. 다시 시도해주세요.");
                });
        }

        // 댓글 목록 갱신 함수
        function updateReplyList() {
            printReplies(1, 10, true);
        }

        // 댓글 목록 출력 함수
        function printReplies(page, size, reset) {
            const currentUserId = window.loggedInUser ? window.loggedInUser.userId : null;
            const boardId = document.getElementById('boardId').value;  // boardId 값을 가져옴

            fetch(`/replies/list`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ boardId: boardId, page: page, size: size })  // 데이터 전송
            })
                .then(response => response.json())
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error("Received data is not an array");
                    }

                    const replyList = document.getElementById("replyList");
                    replyList.innerHTML = "";  // 기존 목록 초기화

                    data.forEach(reply => {
                        const replyItem = document.createElement("li");
                        replyItem.classList.add("list-group-item");

                        // 조건에 따라 배경색을 다르게 지정
                        if (reply.userId == currentUserId) {
                            replyItem.style.backgroundColor = "#f0f8ff";  // 예를 들어 연한 파란색 배경
                        }

                        // 댓글 내용과 작성자를 설정하고, 삭제 버튼은 조건부로 추가
                        replyItem.innerHTML = `
                <strong>${reply.replyer}</strong>: ${reply.content}
                <br><small>${new Date(reply.createdDate).toLocaleString()}</small>
                ${reply.userId == currentUserId ? `<button class="removeReplyBtn btn btn-danger float-end btn-sm" onclick="removeReply(${reply.replyId})">댓글삭제</button>` : ''}
            `;

                        replyList.appendChild(replyItem);
                    });
                })
                .catch(error => console.error("Error loading replies:", error));
        }


        // 댓글 삭제 기능
        function removeReply(replyId) {
            if (confirm("정말로 댓글을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
                fetch(`/replies/${replyId}`, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            alert("댓글이 성공적으로 삭제되었습니다.");
                            window.location.reload(); // 페이지 새로고침
                        } else {
                            alert("댓글 삭제에 실패했습니다. 다시 시도해주세요.");
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting reply:", error);
                        alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
                    });
            }
        }
    </script>

</div>
</html>
