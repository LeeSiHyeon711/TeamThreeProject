<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic}" lang="ko">
<meta charset="UTF-8">

<div layout:fragment="content">
    <div class="container mt-5">
        <input type="hidden" id="boardId" th:value="${dto.boardId}">
        <input type="hidden" id="userId" th:value="${loggedInUser != null ? loggedInUser.userId : 0}">
        <h2 th:text="${dto.title}">Board Title</h2>

        <div class="form-group mt-3">
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="purchaseLink" th:value="${dto.purchaseLink}" readonly>
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onclick="copyLink()">
                        <img th:src="@{/images/copyLink.png}" alt="링크 복사" style="width: 24px; height: 24px;">
                    </button>
                </div>
            </div>
            <small id="copyAlert" class="form-text text-muted" style="display: none;">URL copied to clipboard!</small>
        </div>

        <div class="form-group mt-3">
            <div th:if="${dto.fileNames != null && !dto.fileNames.isEmpty()}">
                <div th:each="file : ${dto.fileNames}" class="mt-2">
                    <th:block th:if="${file.toLowerCase().endsWith('.png') || file.toLowerCase().endsWith('.jpg') || file.toLowerCase().endsWith('.jpeg') || file.toLowerCase().endsWith('.gif')}">
                        <img th:src="@{/upload/{file}(file=${file})}" class="img-thumbnail" style="max-width: 100%; height: auto; margin: 5px;" alt="Image preview">
                    </th:block>
                    <th:block th:if="${!(file.toLowerCase().endsWith('.png') || file.toLowerCase().endsWith('.jpg') || file.toLowerCase().endsWith('.jpeg') || file.toLowerCase().endsWith('.gif'))}">
                        <p><a th:href="@{/upload/{file}(file=${file})}" th:text="${file}" target="_blank">File Download</a></p>
                    </th:block>
                </div>
            </div>
            <div th:if="${dto.fileNames == null || dto.fileNames.isEmpty()}">
                <p>No files uploaded.</p>
            </div>
        </div>

        <div class="form-group mt-4">
            <p th:text="${dto.content}">This is the content of the post.</p>
        </div>

        <a href="/list" class="btn btn-secondary mt-4">돌아가기</a>
        <!-- 삭제 버튼 (로그인한 사용자가 작성한 글일 때만 나타나게 하기) -->
        <div th:if="${loggedInUser != null and loggedInUser.userId == dto.userId}">
            <button type="button" class="btn btn-danger" th:onclick="|deletePost(${dto.boardId})|" >삭제</button>
            <button type="button" class="btn btn-info" th:onclick="|modifyPost(${dto.boardId})|" >수정</button>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="my-4 ">
                <button class="btn btn-info addReplyBtn">ADD REPLY</button>
            </div>
            <ul class="list-group replyList">
                <li th:each="reply : ${replies}" class="list-group-item">
                    <strong th:text="${reply.replyer}">작성자</strong>:
                    <span th:text="${reply.content}">댓글 내용</span>
                    <p th:text="${#temporals.format(reply.createdDate, 'yyyy-MM-dd HH:mm')}"></p>
                </li>
            </ul>

        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <ul class="pagination replyPaging">
            </ul>
        </div>
    </div>

    <div class="modal registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register Reply</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Reply Text</span>
                        <input type="text" class="form-control replyText" name="content" placeholder="댓글을 입력하세요"> <!-- 댓글 내용을 content로 설정 -->
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Replyer</span>
                        <input type="text" class="form-control replyer" name="replyer" placeholder="작성자 이름">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary registerBtn">Register</button>
                    <button type="button" class="btn btn-outline-dark closeRegisterBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- end regist modal -->

    <div class="modal modifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title replyHeader"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Reply Text</span>
                        <input type="text" class="form-control modifyText" >
                    </div>
                </div>


                <div class="modal-footer">
                    <button type="button" class="btn btn-info modifyBtn">Modify</button>
                    <button type="button" class="btn btn-danger removeBtn">Remove</button>
                    <button type="button" class="btn btn-outline-dark closeModifyBtn">Close</button>
                </div>
            </div>
        </div>
    </div> <!--modifyModal -->

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // 링크 복사 기능
        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url)
                .then(() => {
                    alert('링크가 복사되었습니다!');
                })
                .catch(err => {
                    console.error('복사에 실패했습니다', err);
                });
        }

        // 게시글 삭제 기능
        function deletePost(boardId) {
            if (confirm("정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
                fetch(`/delete/${boardId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        alert("게시글이 성공적으로 삭제되었습니다.");
                        window.location.href = "/list";  // 삭제 후 리스트 페이지로 이동
                    } else {
                        alert("게시글 삭제에 실패했습니다. 다시 시도해주세요.");
                    }
                }).catch(error => {
                    console.error("Error:", error);
                    alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
                });
            }
        }

        // 게시글 수정 기능
        function modifyPost(boardId) {
            if (confirm("게시글을 수정하시겠습니까?")) {
                window.location.href = `/modify/${boardId}`;
            }
        }

        // 댓글 등록 모달 관련
        const boardId = document.getElementById("boardId").value;
        const registerModal = new bootstrap.Modal(document.querySelector(".registerModal"));
        const registerBtn = document.querySelector(".registerBtn");
        const replyText = document.querySelector(".replyText");
        const replyer = document.querySelector(".replyer");
        const closeRegisterBtn = document.querySelector(".closeRegisterBtn");

        document.querySelector(".addReplyBtn").addEventListener("click", function () {
            registerModal.show();
        });

        closeRegisterBtn.addEventListener("click", function () {
            registerModal.hide();
        });

        // 댓글 등록 버튼 클릭 시
        registerBtn.addEventListener("click", function(e) {
            const replyObj = {
                boardId: document.getElementById('boardId').value,
                userId: document.getElementById('userId').value,
                content: document.querySelector(".replyText").value.trim(), // 댓글 내용
                replyer: document.querySelector(".replyer").value.trim()    // 작성자
            };

            if (replyObj.content) {  // content 값이 존재하는지 확인
                addReply(replyObj);
            } else {
                alert("댓글 내용을 입력해 주세요!");
            }
        });

        // 댓글 수정 모달 관련
        const modifyModal = new bootstrap.Modal(document.querySelector(".modifyModal"));
        const replyIdHeader = document.querySelector(".replyHeader");
        const modifyText = document.querySelector(".modifyText");
        const modifyBtn = document.querySelector(".modifyBtn");
        const removeBtn = document.querySelector(".removeBtn");
        const closeModifyBtn = document.querySelector(".closeModifyBtn");

        document.querySelector(".replyList").addEventListener("click", function (e) {
            const target = e.target;

            if (!target || target.tagName !== 'SPAN') {
                return;
            }

            const replyId = target.getAttribute("data-rno");

            if (!replyId) {
                return;
            }

            getReply(replyId).then(reply => {
                replyIdHeader.innerHTML = reply.rno;
                modifyText.value = reply.replyText;
                modifyModal.show();
            }).catch(e => {
                alert('댓글 불러오기에 실패했습니다.');
            });
        });

        modifyBtn.addEventListener("click", function () {
            const replyData = {
                boardId: boardId,
                rno: replyIdHeader.innerHTML,
                replyText: modifyText.value
            };

            modifyReply(replyData).then(result => {
                alert(result.rno + " 댓글이 수정되었습니다.");
                modifyModal.hide();
                updateReplyList(); // 댓글 목록 갱신
            }).catch(e => {
                alert("댓글 수정에 실패했습니다.");
            });
        });

        closeModifyBtn.addEventListener("click", function () {
            modifyModal.hide();
        });

        removeBtn.addEventListener("click", function () {
            removeReply(replyIdHeader.innerHTML).then(result => {
                alert(result.rno + " 댓글이 삭제되었습니다.");
                modifyModal.hide();
                updateReplyList(); // 댓글 목록 갱신
            }).catch(e => {
                alert("댓글 삭제에 실패했습니다.");
            });
        });
        function addReply(replyObj) {
            fetch("/replies", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(replyObj)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("Failed to add reply");
                    }
                })
                .then(data => {
                    console.log("Reply added:", data);
                    alert("댓글이 성공적으로 등록되었습니다.");

                    // 댓글 목록에 새로운 댓글 추가
                    const replyList = document.getElementById("replyList");
                    const newReply = document.createElement("div");
                    newReply.innerHTML = `
            <div class="reply">
                <p><strong>${data.replyer}</strong>: ${data.replyText}</p>
                <p>${new Date(data.createdDate).toLocaleString()}</p>
            </div>
        `;
                    replyList.appendChild(newReply);
                })
                .catch(error => console.error("Error adding reply:", error));
        }


        // 댓글 목록 갱신 함수
        function updateReplyList() {
            printReplies(1, 10, true);
        }

        function printReplies(page, size, reset) {
            fetch(`/replies?boardId=${boardId}&page=${page}&size=${size}`)
                .then(response => response.json())
                .then(data => {
                    const replyList = document.getElementById("replyList");
                    replyList.innerHTML = "";  // 기존 목록 초기화
                    data.forEach(reply => {
                        const replyItem = document.createElement("li");
                        replyItem.classList.add("list-group-item");
                        replyItem.innerHTML = `
                    <strong>${reply.replyer}</strong>: ${reply.content}
                    <br><small>${new Date(reply.createdDate).toLocaleString()}</small>
                `;
                        replyList.appendChild(replyItem);
                    });
                })
                .catch(error => console.error("Error loading replies:", error));
        }

    </script>

</div>
</html>
